openapi: 3.0.0
servers:
  - url: https://spxon.getid.dev/
    description: Production server
  - url: https://spxon.sb.getid.dev/
    description: Sandbox server
info:
  title: Enveloped Application
  version: "2.0"
  x-logo:
    url: "./logo.svg"
    altText: GetID

  description: |

    # API
    Information about API

    # SDK
    Information about API

paths:
  /api/v1/application:
    post:
      security:
        - ApiKeyAuth: []
      description: Send application for verification
      requestBody:
        content:
          "application/json":
            schema:
              $ref: "#/components/schemas/EnvelopedApplication"
      responses:
        "200":
          description: OK
          content:
            "application/json":
              schema:
                properties:
                  responseCode:
                    type: integer
                    enum: [200]
                  id:
                    type: string
                    format: ObjectId
                    example: 5e62110968e3fb4d655756d1
        "400":
          description: Empty request body
          content:
            "application/json":
              schema:
                properties:
                  responseCode:
                    type: integer
                    enum: [400]
        "401":
          description: Missing or wrong authorization headers
          content:
            "application/json":
              schema:
                properties:
                  responseCode:
                    type: integer
                    enum: [401]
                  errorMessage:
                    type: string
                    example: Unauthorized
        "402":
          description: Wrong format or missing data
          content:
            "application/json":
              schema:
                properties:
                  responseCode:
                    type: integer
                    enum: [402]
  /api/v1/application/{id}:
    get:
      security:
        - ApiKeyAuth: []
      description: Get verified application
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            "application/json":
              schema:
                $ref: "#/components/schemas/VerificationResult"

        "401":
          description: Missing or wrong authorization headers
          content:
            "application/json":
              schema:
                properties:
                  responseCode:
                    type: integer
                    enum: [401]
                  errorMessage:
                    type: string
                    example: Unauthorized
        "402":
          description: Application not found
          content:
            "application/json":
              schema:
                properties:
                  responseCode:
                    type: integer
                    enum: [402]

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        You can find token on settings page.
        It's required for all API methods.
  schemas:
    EnvelopedApplication:
      type: object
      properties:
        metadata:
          $ref: "#/components/schemas/SourceMetadata"
        application:
          $ref: "#/components/schemas/Application"
        verificationTypes:
          $ref: "#/components/schemas/VerificationTypes"
    VerificationResult:
      type: object
      properties:
        responseCode:
          type: integer
          description: contains HTTP code (200)
          enum: [200]
        id:
          type: string
          description: Application id
          format: ObjectId
          example: 5e62110968e3fb4d655756d1
        metadata:
          $ref: "#/components/schemas/ResultMetadata"
        application:
          $ref: "#/components/schemas/Application"
        verificationTypes:
          $ref: "#/components/schemas/VerificationTypes"
        processingState:
          $ref: "#/components/schemas/ProcessingState"
        overallResult:
          $ref: "#/components/schemas/OverallResult"
        servicesResults:
          $ref: "#/components/schemas/ServiceResults"
      required:
        - id
        - responseCode
        - metadata
        - application
        - processingState

    Application:
      type: object
      description: The data to verify
      properties:
        fields:
          type: array
          description: |
            Data fields to check.

            For example: Last Name and Date of Birth sent from web form
          items:
            $ref: "#/components/schemas/Field"
          example:
            - contentType: string
              content: First Name
              category: Artem
              requireCheck: true
            - contentType: string
              content: Last Name
              category: Gerus
              requireCheck: true
            - contentType: sex
              content: male
              category: sex
            - contentType: bool
              content: "true"
              category: Agree on something
        documents:
          type: array
          description: Documents for data extraction or cross-checking
          items:
            type: object
            properties:
              issuingCountry:
                type: string
                description: Country code of country of issue https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2
                pattern: ^[a-zA-Z]{2}$
                examples: [UK, GB, DE]
              documentType:
                $ref: "#/components/schemas/DocumentType"
              files:
                description: Document photos or scans
                type: array
                items:
                  $ref: "#/components/schemas/DocumentMedia"
            required:
              - files
        selfie:
          description: Information for `face-matching` or `liveness`
          properties:
            files:
              type: array
              description: list of selfies for face-matching
              items:
                $ref: "#/components/schemas/FacesMedia"
          required:
            - files

    Field:
      type: object
      oneOf:
        - $ref: "#/components/schemas/StringField"
        - $ref: "#/components/schemas/DateField"
        - $ref: "#/components/schemas/SexField"
        - $ref: "#/components/schemas/BoolField"
        - $ref: "#/components/schemas/CountryField"
        - $ref: "#/components/schemas/NumberField"

    FieldBase:
      type: object
      properties:
        category:
          type: string
          description: |
            Kind of data.

            For example: First Name, Date of Birth...
          examples: [First Name, Date of Birth]

    StringField:
      type: object
      allOf:
        - type: object
          properties:
            contentType:
              type: string
              enum: [string]
            content:
              type: string
              description: String value
        - $ref: "#/components/schemas/FieldBase"
      required: [content, category, contentType]

    DateField:
      type: object
      allOf:
        - type: object
          properties:
            contentType:
              type: string
              enum: [date]
            content:
              format: date
              type: string
              description: The value with date
        - $ref: "#/components/schemas/FieldBase"
      required: [content, category, contentType]

    SexField:
      type: object
      allOf:
        - type: object
          properties:
            contentType:
              type: string
              enum: [sex]
            content:
              enum: [male, female]
              type: string
              description: male or female
        - $ref: "#/components/schemas/FieldBase"
      required: [content, category, contentType]

    NumberField:
      type: object
      allOf:
        - type: object
          properties:
            contentType:
              type: string
              enum: [number]
            content:
              format: number
              type: string
              description: The number value
        - $ref: "#/components/schemas/FieldBase"
      required: [content, category, contentType]

    CountryField:
      type: object
      allOf:
        - type: object
          properties:
            contentType:
              type: string
              enum: [country]
            content:
              type: string
              description: The country code https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2
              pattern: ^[a-zA-Z]{2}$
              examples: [UK, GB, DE]
        - $ref: "#/components/schemas/FieldBase"
      required: [content, category, contentType]

    BoolField:
      type: object
      allOf:
        - type: object
          properties:
            contentType:
              type: string
              enum: [bool]
            content:
              enum:
                - "true"
                - "false"
              type: string
              example: "true"
              description: The bool value
        - $ref: "#/components/schemas/FieldBase"
      required: [content, category, contentType]

    FacesMedia:
      type: object
      properties:
        id:
          type: string
          description: file id (filled automatically when missing)
        url:
          description: URL address of downloadable image or Data URI
          type: string
          examples:
            - data:image/png;base64,R0lGODlhDAAMAK...
            - https://example.com/image.jpg
      required: [url]

    DocumentMedia:
      type: object
      properties:
        id:
          type: string
          description: file id (filled automatically when missing)
        kind:
          type: string
          description: kind of document page
          enum:
            - front
            - back
            - page
          example: front
        url:
          description: URL address of downloadable image or Data URI
          type: string
          examples:
            - data:image/png;base64,R0lGODlhDAAMAK...
            - https://example.com/image.jpg
      required: [url, kind]

    Extensions:
      type: array
      items:
        type: object
        properties:
          extension:
            type: string
            example: my extension
          extensionData:
            type: string
            # example: {substructure}
            description: contains substructure in JSON
        required: [extension, extensionData]

    OverallResult:
      nullable: true
      type: object
      description: Summary verification result (`null` if state isn't `done`)
      properties:
        status:
          description: The worst result from all services
          $ref: "#/components/schemas/VerificationStatus"
        verifierComments:
          type: array
          description: Array of results from all services (You can find full results in a servicesResults section)
          items:
            type: object
            properties:
              service:
                description: Service name
                type: string
              text:
                description: Short comment for result
                type: string
              status:
                $ref: "#/components/schemas/VerificationStatus"
          example:
            - service: face-matching
              text: faces are similar
              status: approved
            - service: watchlists
              text: "found 2 reports against the person"
              status: declined
            - service: extract-data
              text: data was extracted
              status: approved

        validationDate:
          type: string
          description: The date of validation completion
          format: date-time
          example: "2020-03-17T20:28:37.061Z"
      additionalProperties: false
      required:
        - status
        - verifierComments
        - validationDate
    VerificationStatus:
      type: string
      description: |
        The result of verification:
        * `approved` - no problems are found
        * `declined` - application is declined due to some problems
        * `review-needed` - TODO
        * `error` - error was occured
      enum:
        - declined
        - approved
        - review-needed
        - error
    ProcessingState:
      type: string
      enum:
        - done
        - processing
        - manual-checking
      description: |
        Application processing state:
          * `done` - processing is finished
          * `processing` - application is still being processed
          * `manual-checking` - application is being manually checked

    SourceMetadata:
      type: object
      description: |
        The meta information about the source of the input data.
        This field can be used to add custom meta information.
        It's also will be added to the response as is.

        Max number of properties is 30
      maxProperties: 30
      properties:
        customerId:
          type: string
          description: Use this field to set custom ID from your system
          example: ID-342
        platform:
          type: string
          description: The platform type the application is sent from
          example:
            - android
            - ios
            - web
        clientName:
          type: string
          description: The name of the client which sent the request
          example: my-api-client
        clientVersion:
          type: string
          description: The version of the client which sent the request
          example: 1.0.0
        locale:
          type: string
          description: The locale of the client which sent the request
          format: locale
          example: en_US
      additionalProperties:
        x-additionalPropertiesName: x-
        description: Custom properties can be added with prefix `x-`
        type: string
      example:
        platform: android
        locale: en_US
        appName: my-api-client
        appVersion: 1.0.0
        x-my-custom-meta-name-1: custom-value-1
        x-my-custom-meta-name-2: custom-value-2
    ResultMetadata:
      allOf:
        - type: object
          properties:
            ip:
              type: string
              description: IP from which the request was sent
              format: ip
              example: 8.8.8.8
            createdAt:
              description: time when the application was created
              type: string
              format: date-time
              example: "2020-03-17T20:28:37.061Z"
        - $ref: "#/components/schemas/SourceMetadata"
      nullable: false

    ServiceResults:
      type: object
      properties:
        faceMatching:
          $ref: "#/components/schemas/FaceMatching"
        #liveness:
        #  $ref: "#/components/schemas/Liveness"
        dataExtraction:
          $ref: "#/components/schemas/DataExtraction"
        crossChecking:
          $ref: "#/components/schemas/CrossChecking"
        watchlists:
          $ref: "#/components/schemas/Watchlists"
      additionalProperties: false
      nullable: true
    FaceMatching:
      type: object
      description: Face-matching service compares photo on the document with selfie
      properties:
        comment:
          description: Short comment for result
          type: string
        verifier:
          description: Name of verifier
          type: string
        status:
          $ref: "#/components/schemas/VerificationStatus"
        processingState:
          $ref: "#/components/schemas/ProcessingState"
        results:
          $ref: "#/components/schemas/FaceMatchingResult"
        settings:
          type: object
          description: settings determining the resulting status
          properties:
            declineMaxScore:
              description: level to which a decision will be made about `declined` status
              type: number
              example: 0.4
            approveMinScore:
              description: level from which a decision will be made about `approve` status
              type: number
              example: 0.6
      required:
        - status
      examples:
        - status: approved
          verifier: SphereX
          comment: Faces are similar
          settings:
            declineMaxScore: 0.4
            approveMinScore: 0.6
          results:
            score: 0.7
      additionalProperties: false
    FaceMatchingResult:
      type: object
      description: Result of face matching service
      properties:
        files:
          description: list of file ids which were involved in checking (from selfie and documents)
          type: array
          items:
            type: string
        score:
          description: faces similarity score
          type: number
          example: 0.3
      required:
        - score
        - files
      additionalProperties: false
    Liveness:
      type: object
      properties:
        verifierComment:
          type: string
        verifier:
          type: string
        status:
          $ref: "#/components/schemas/VerificationStatus"
        processingState:
          $ref: "#/components/schemas/ProcessingState"
        results:
          type: array
          items:
            $ref: "#/components/schemas/LivenessResult"
      required:
        - status
      additionalProperties: false
    LivenessResult:
      type: object
    DataExtraction:
      type: object
      properties:
        comment:
          type: string
        verifier:
          type: string
        status:
          $ref: "#/components/schemas/VerificationStatus"
        processingState:
          $ref: "#/components/schemas/ProcessingState"
        extracted:
          type: object
          properties:
            ocr:
              type: array
              items:
                $ref: "#/components/schemas/DataExtractionResult"
            mrz:
              type: array
              items:
                $ref: "#/components/schemas/DataExtractionResult"
            nfc:
              type: array
              items:
                $ref: "#/components/schemas/DataExtractionResult"
      required:
        - status
      additionalProperties: false
      example:
        comment: Data was extracted
        verifier: Regula
        status: approved
        extracted:
          ocr:
            - contentType: string
              category: First name
              content: Joe
            - contentType: string
              category: First name
              content: Джо
              locale: ru_RU
            - contentType: string
              category: Last name
              content: Black
          mrz:
            - contentType: string
              category: First name
              content: James
            - contentType: string
              category: Last name
              content: Black
          nfc:
            - contentType: string
              category: First name
              content: Joe
            - contentType: string
              category: Last name
              content: Black

    DataExtractionResult:
      type: object
      properties:
        contentType:
          $ref: "#/components/schemas/ContentType"
        category:
          type: string
          description: The name of the extracted field
        content:
          type: string
          description: The value of the extracted field
        locale:
          type: string
          description: The locale of the extracted value
          examples: [en_UK, en_AU, zh_CN, zh_SG]
      required:
        - contentType
        - category
        - content
      additionalProperties: false

    CrossChecking:
      type: object
      properties:
        verifierComment:
          type: string
        verifier:
          type: string
        status:
          $ref: "#/components/schemas/VerificationStatus"
        processingState:
          $ref: "#/components/schemas/ProcessingState"
        results:
          type: array
          items:
            $ref: "#/components/schemas/CrossCheckingResult"
      required:
        - status
      additionalProperties: false
    CrossCheckingResult:
      type: object
      properties:
        category:
          type: string
          example:
            - First name
            - Last name
            - Date of Birth
        field:
          type: string
        extracted:
          type: string
      required:
        - category
        - field
        - extracted
      additionalProperties: false
    Watchlists:
      type: object
      properties:
        verifierComment:
          type: string
        verifier:
          type: string
        status:
          $ref: "#/components/schemas/VerificationStatus"
        processingState:
          $ref: "#/components/schemas/ProcessingState"
        results:
          type: array
          items:
            $ref: "#/components/schemas/WatchlistsResult"
      required:
        - status
      additionalProperties: false
    WatchlistsResult:
      type: object
      properties:
        contentType:
          $ref: "#/components/schemas/ContentType"
        category:
          type: string
        content:
          type: string
      required:
        - contentType
        - category
        - content
      additionalProperties: false
    ContentType:
      type: string
      enum:
        - string
        - number
        - sex
        - date
        - country
        - boolean

    VerificationTypes:
      type: array
      description: |
        List of requested verifications:
        * watchlists - check user on PEPs (fields `First name` and `Last name` must be filled)
        * face-matching - compare photo on the document with selfie (selfie list and document list must be provided)
        * extract-data - extract data from the documents (documents must be provided)
        * crosschecking - check the conformity between fields and extracted data

        If the list isn't provided, all verifications will be applied.
      items:
        type: string
        enum: ["watchlists", "face-matching", "extract-data", "crosschecking"]
      example: ["watchlists", "face-matching", "extract-data"]

    DocumentType:
      type: string
      description: Kind of the document
      enum:
        - passport
        - id-card
        - driving-licence
        - residence-permit
      example: id-card
